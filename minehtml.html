<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>MineGame</title>
</head>
<body>
    <canvas id="mycanv" width="10000" height="10000"></canvas>
    <script>
        //è·å–ç”»å¸ƒå˜é‡
        var canv = document.getElementById('mycanv');
        var ctx = canv.getContext('2d');
        //é»˜è®¤ä¼ è¾“å˜é‡
        var DEFAULT_ROW_SIZE = 300;
        var DEFAULT_COL_SZIE = 300;
        var DEFAULT_SEED = 1437;
        var DEFAULT_MOD = 33554393;
        var DEFAULT_PART_SIZE = 16;
        var DEFAULT_PART_MINE_NUM = 48;
        var DEFAULT_DELTA = DEFAULT_SEED;
        var fib1 = 1;
        var fib2 = 2;
        //å…¨éƒ¨åæ ‡ä¿¡æ¯
        var g_arr = [];
        /*********************************************************
         * g_obj å˜é‡è®°å½•äº†æ¯ä¸ªåæ ‡(x,y)çš„å…·ä½“ä¿¡æ¯
         * 1.mark ï¼š å³æ ¼å­ä¸­åº”æ˜¾ç¤ºçš„æ•°å­—ï¼Œå…¶ä¸­ -1 ä¸ºç‚¸å¼¹ï¼Œå…¶ä»–åˆ™è¡¨ç¤ºæ ¼å­å‘¨å›´æœ‰å¤šå°‘ç‚¸å¼¹
         * 2.open ï¼š å³å½“å‰æ ¼å­æœ‰æ²¡æœ‰è¢«æ‰“å¼€ 0 å…³é—­ 1 æ‰“å¼€
         * 3.init ï¼š ç”Ÿæˆé›·æ—¶ç”¨åˆ°çš„åˆå§‹åŒ–æ•°
         * 4.time ï¼š æ—¶é—´æˆ³ï¼Œç”¨äºåˆ¤æ–­ç”¨æˆ·çš„å…ˆåé¡ºåº
         * ... (æ ¹æ®éœ€æ±‚å¯è‡ªè¡Œæ·»åŠ )
         * ******************************************************/
        var g_obj = {};
        //é¢œè‰²æ•°æ®,è®°å½•äº†é›·ï¼Œæ ¼å­ç­‰åº”ç”¨ä»€ä¹ˆé¢œè‰²
        var g_color = {block:'#369',mine:'#bbb',open:'#ddd',highlight:'#89f'};
        //å›¾æ ‡æ•°æ®ï¼Œåˆ©ç”¨å­—ç¬¦å›¾æ ‡åœ¨æ ¼å­ä¸Šå¡«å……ä¿¡æ¯
        var mine = ['ğŸ’£', 'ğŸš©', 'â”', 'ğŸ’¥'];
        //è®°å½•é›·çš„æ•°ç»„ï¼Œè®°å½•äº†æ‰€æœ‰æ˜¯é›·çš„åæ ‡
        var mine_arr = [];
        //å…¨éƒ¨çš„æ ¼å­æ•°
        var count;
        //æ˜¯é›·çš„æ ¼å­æ•°
        var mine_count;
        //æ¯ä¸ªæ ¼å­çš„å®½åº¦
        var w = 30;
        //åœ†è§’çŸ©å½¢çš„åœ†è§’åŠå¾„
        var r=8;
        //æ¯ä¸ªæ ¼å­ä¹‹é—´ç›¸éš”çš„è·ç¦»
        var m=2;

        //å¯åŠ¨å‡½æ•°
        function start(){
            init(300,300,1437,33554393,16,48);
            get_mine();
            setMine();
        }

        start();

        //è®¾ç½®æ‰€ç”»åœ†è§’çŸ©å½¢çš„å®½åº¦ï¼Œåœ†è§’åŠå¾„ä¸é—´è·
        function set_from(weight,radius,dis){
            w = weight;
            r = radius;
            m = dis;
        }

        //åˆå§‹åŒ–å‡½æ•°
        function init(row,col,seed,mod,size,mine_num){
            //è®¾ç½®åˆå§‹åŒ–å˜é‡
            DEFAULT_ROW_SIZE = row;
            DEFAULT_COL_SZIE = col;
            DEFAULT_SEED = seed;
            DEFAULT_MOD = mod;
            DEFAULT_PART_SIZE = size;
            DEFAULT_PART_MINE_NUM = mine_num;
            DEFAULT_DELTA = seed;
            count = row * col;
            mine_count = 0;
            //å¾ªç¯ç”Ÿæˆåæ ‡ä¿¡æ¯ï¼Œå¹¶åœ¨canvasä¸­ç”»å‡º
            for(let i=0;i<DEFAULT_ROW_SIZE;i++){
                for(let j=0;j<DEFAULT_COL_SZIE;j++){
                    let xy = j + '-' + i;
                    g_arr.push(xy);
                    g_obj[xy] = {mark:0,open:0,init:0,time:999999};
                    drawBlock(xy,g_color.block);
                }
            }
        }

        //è·å¾—åœ°é›·æ•°ç»„
        function get_mine(){
            //å¯¹äºæ¯ä¸ªå­å—çš„è¡Œåˆ—å¤§å°
            let currow,curcol;
            //å¾ªç¯çš„åˆ°æ¯ä¸ªå­å—å·¦ä¸Šè§’çš„ç¬¬ä¸€ä¸ªå—
            for(let i = 0;i<DEFAULT_ROW_SIZE;i+=DEFAULT_PART_SIZE){
                for(let j = 0;j<DEFAULT_COL_SZIE;j+=DEFAULT_PART_SIZE){
                    //åˆ¤æ–­æ˜¯å¦è¶Šç•Œï¼Œå¹¶è®¡ç®—å­å—çš„è¾¹é•¿
                    if(i+DEFAULT_PART_SIZE>DEFAULT_ROW_SIZE)
                        currow = DEFAULT_ROW_SIZE - i;
                    else
                       currow = DEFAULT_PART_SIZE;
                    
                    if(j+DEFAULT_PART_SIZE>DEFAULT_COL_SZIE)
                        curcol = DEFAULT_COL_SZIE - j;
                     else
                        curcol = DEFAULT_PART_SIZE;
                    
                    
                    //åˆå§‹åŒ–å­å—ä¿¡æ¯
                    let cnt = 0;
                    let num = currow * curcol * DEFAULT_PART_MINE_NUM;
                    num = ~~(num / (DEFAULT_PART_SIZE * DEFAULT_PART_SIZE));
                    mine_count +=  num ;
                    //ç”Ÿæˆå­å—å†…éƒ¨é›·ç¼–å·
                    for(let k = i;k<i+currow;k++){
                        for(let l = j;l<j+curcol;l++){
                            let kl = l +'-' + k;
                            g_obj[kl].init = cnt;
                            cnt++; 
                        }
                    }
                    
                    //åˆ©ç”¨ç®—æ³•æ‰“ä¹±å†…éƒ¨é¡ºåº
                    for(let k = i;k<i+currow;k++){
                        for(let l = j;l<j+curcol;l++){
                            let kl = l +'-' + k;
                            get_change(currow,curcol,i,j,kl);
                        }
                    }


                    //æ ¹æ®æ‰“ä¹±çš„ç¼–å·æ‰¾åˆ°é›·å¹¶æ”¾å…¥mine_arr
                    for(let k = i;k<i+currow;k++){
                        for(let l = j;l<j+curcol;l++){
                            let kl = l +'-' + k;
                            if(g_obj[kl].init < num){
                                mine_arr.push(kl);
                                g_obj[kl].mark = -1;
                            }
                        }
                    }
                }
            }
        }
        

        //è·å¾—ç”Ÿæˆé›·ç®—æ³•ä¸­è¦äº¤æ¢çš„åæ ‡
        function get_change(row,col,i,j,kl){

            //è¿­ä»£æ–æ³¢é‚£å¥‘æ•°ç»„
            let temp = fib1 ;
            fib1 = fib2;
            fib2 = (temp + fib2)%DEFAULT_MOD;
            //è¿­ä»£ç§å­
            while(true){
                DEFAULT_DELTA = (DEFAULT_DELTA * fib1) % DEFAULT_MOD;
                if(DEFAULT_DELTA>row*col)
                    break;
            }
            //ç”Ÿæˆè¦äº¤æ¢çš„åæ ‡
            let y = DEFAULT_DELTA % row ;
            temp = DEFAULT_DELTA;
            temp = ~~(temp / row) ;
            let x = temp % col ;
            let xy = `${x+j}-${y+i}`;
            //è¿›è¡Œäº¤æ¢
            temp = g_obj[xy].init;
            g_obj[xy].init = g_obj[kl].init;
            g_obj[kl].init = temp;
        }

        //æ ¹æ®ç”Ÿæˆçš„mine_arræ•°ç»„å¯¹æ¯ä¸ªåæ ‡çš„markå€¼è¿›è¡Œè®¡ç®—
        function setMine(){
            mine_arr.forEach(n=>{
                g_obj[n].mark=-1;
                let around = getAround(n);
                around.forEach(xy=>{
                    if(g_obj[xy].mark!=-1)
                        g_obj[xy].mark++;
                });
            })
        }

        //è¾…åŠ©æ˜¾ç¤ºå‡½æ•°ï¼Œæ–¹ä¾¿è°ƒè¯•ï¼Œæ­£å¼ä½¿ç”¨æ—¶è¯·æ³¨é‡Š
        showInfo();

        function showInfo(){
            g_arr.forEach(n=>{
                if(g_obj[n].mark==-1){
                    drawBlock(n,g_color.mine);
                    markText(n,mine[0]);
                }else{
                    markText(n,g_obj[n].mark);
                }
            })
        }

        //æ˜¾ç¤ºæ–‡æœ¬å‡½æ•°ï¼Œç”¨äºè®©æ ¼å­ä¸Šæ˜¾ç¤ºå¯¹åº”çš„å€¼
        function markText(xy,txt){
            let [x,y] = xy.split('-').map(n=>n*w);
            ctx.save();
            ctx.font='15px Arial';
            ctx.fillStyle='#fff';
            ctx.textAlign='center';
            ctx.textBaseline='middle';
            ctx.fillText(txt,x+w/2,y+w/2);
            ctx.restore();
        }

        //è·å¾—(x,y)åæ ‡å‘¨å›´å…«ä¸ªæ ¼å­å†…æ‰€æœ‰åˆæ³•åæ ‡
        function getAround(xy){
            let [x,y] = xy.split('-').map(n=>n*1);
            let around = [];
            for(let i=-1;i<=1;i++){
                for(let j=-1;j<=1;j++){
                    let id = `${x+j}-${y+i}`;
                    if(g_arr.includes(id)&&id!=xy)
                        around.push(id);
                }
            }
            return around;
        }

        //ç”»åœ†è§’çŸ©å½¢çš„å‡½æ•°ï¼Œå…¶ä¸­(x,y)ä¸ºåæ ‡ï¼Œcä¸ºè¦å¡«å……çš„é¢œè‰²æˆ–æ ·å¼
        function drawBlock(xy,c){
            let [x,y] = xy.split('-').map(n=>n*w);
            ctx.save();
            ctx.beginPath();
            ctx.moveTo(x,y+r);
            ctx.arcTo(x,y+w-m,x+w-m,y+w-m,r);
            ctx.arcTo(x+w-m,y+w-m,x+w-m,y,r);
            ctx.arcTo(x+w-m,y,x,y,r);
            ctx.arcTo(x,y,x,y+w-m,r);
            ctx.fillStyle = c;
            ctx.fill();
            ctx.restore();
        }

        //ä¸ºç”»å¸ƒå¢åŠ ç›‘å¬äº‹ä»¶
        canv.addEventListener('click',openBlock);
        //ç›‘å¬å‡½æ•°
        function openBlock(ev){
            //è·å¾— xä¸yåæ ‡
            let x =~~(ev.offsetX/w);
            let y =~~(ev.offsetY/w);
            let xy = x + '-' + y;
            if(g_obj[xy].open==0)
                count -- ;
            g_obj[xy].open=1;
            //æ”¹å˜æ ¼å­çŠ¶æ€
            drawBlock(xy,g_color.open);
            markText(xy,g_obj[xy].mark);
            //å¦‚æœä¸º0åˆ™dfsï¼Œä¸ºé›·åˆ™ç‚¸
            if(g_obj[xy].mark==0){
                dfszero(xy);
            }else if(g_obj[xy].mark==-1){
                count--;
                mine_count--;
                drawBlock(xy,g_color.mine);
                markText(xy,mine[0]);
                markText(xy,mine[3]);
                alert("é›·ç‚¸äº†ï¼ï¼ï¼ï¼ï¼");
            }
            console.log(x,y);
            //æ£€æŸ¥æ˜¯å¦ç»“æŸ
            checkOver();
        }

        //å¯¹äº0çš„dfs
        function dfszero(xy){
            let around = getAround(xy);
            around.forEach(n=>{
                if(g_obj[n].open==0){
                    count --;
                    g_obj[n].open=1;
                    drawBlock(n,g_color.open);
                    markText(n,g_obj[n].mark);
                    if(g_obj[n].mark==0)
                        dfszero(n);
                }
            })
        }

        //æ£€æŸ¥æ˜¯å¦ç»“æŸå‡½æ•°ï¼Œå¦‚æœå‰©ä¸‹çš„æ ¼å­å…¨æ˜¯é›·åˆ™ç»“æŸ
        function checkOver(){
            let over = 0;
            if(count == mine_count){
                over = 1;
                alert("èƒœåˆ©ï¼ï¼");
            }  
            return over;
        }

        //æ ¹æ®æ—¶é—´æˆ³è¿›è¡Œä¸Šè‰²
        function dfstime(){

        }

    </script>
</body>
</html>