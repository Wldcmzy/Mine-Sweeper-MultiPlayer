<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>MineGame</title>
    <style>

        .contextmenu {
            width: 350px;
            border: 1px solid #999;
            box-shadow: 3px 3px 3px #ccc;
            background-color: #fff;
            position: absolute;
            top: 10px;
            left: 15px;
            display: none;
            z-index: 9999999
        }

    </style>
</head>

<body>
    <canvas id="mycanv" width="10000" height="10000"></canvas>
    <div class="contextmenu" id="context">
        <table>
            <thead>
                <div>
                    <a href="" target="_blank" id="totallink"><font color="blue">æŸ¥çœ‹æ€»æ¦œ</font></a>
                </div>
            </thead>
            <thead>
                æœ¬å±€æ‰«é›·æ’è¡Œæ¦œ&nbsp;&nbsp;&nbsp;
            </thead>
            <thead>
                <tr>
                    <th>ç”¨æˆ·å&nbsp;&nbsp;</th>
                    <th>å‘å£å€¼</th>
                    <th>å¼€è’æ•°</th>
                    <th>K/D</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    <script>
        //è·å–ç”»å¸ƒå˜é‡
        var canv = document.getElementById('mycanv');
        var ctx = canv.getContext('2d');
        //é»˜è®¤ä¼ è¾“å˜é‡
        var DEFAULT_ROW_SIZE = 300;
        var DEFAULT_COL_SZIE = 300;
        var DEFAULT_SEED = 1437;
        var DEFAULT_MOD = 33554393;
        var DEFAULT_PART_SIZE = 16;
        var DEFAULT_PART_MINE_NUM = 48;
        var DEFAULT_DELTA = DEFAULT_SEED;
        var fib1 = 1;
        var fib2 = 2;
        //å…¨éƒ¨åæ ‡ä¿¡æ¯
        var g_arr = [];
        /*********************************************************
         * g_obj å˜é‡è®°å½•äº†æ¯ä¸ªåæ ‡(x,y)çš„å…·ä½“ä¿¡æ¯
         * 1.mark ï¼š å³æ ¼å­ä¸­åº”æ˜¾ç¤ºçš„æ•°å­—ï¼Œå…¶ä¸­ -1 ä¸ºç‚¸å¼¹ï¼Œå…¶ä»–åˆ™è¡¨ç¤ºæ ¼å­å‘¨å›´æœ‰å¤šå°‘ç‚¸å¼¹
         * 2.open ï¼š å³å½“å‰æ ¼å­æœ‰æ²¡æœ‰è¢«æ‰“å¼€ 0 å…³é—­ 1 æ‰“å¼€
         * 3.init ï¼š ç”Ÿæˆé›·æ—¶ç”¨åˆ°çš„åˆå§‹åŒ–æ•°
         * 4.time ï¼š æ—¶é—´æˆ³ï¼Œç”¨äºåˆ¤æ–­ç”¨æˆ·çš„å…ˆåé¡ºåº
         * ... (æ ¹æ®éœ€æ±‚å¯è‡ªè¡Œæ·»åŠ )
         * ******************************************************/
        var g_obj = {};
        //é¢œè‰²æ•°æ®,è®°å½•äº†é›·ï¼Œæ ¼å­ç­‰åº”ç”¨ä»€ä¹ˆé¢œè‰²
        var g_color = { block: '#CCDDFF', mine: '#bbb', open: '#ddd', highlight: '#89f' };
        //å›¾æ ‡æ•°æ®ï¼Œåˆ©ç”¨å­—ç¬¦å›¾æ ‡åœ¨æ ¼å­ä¸Šå¡«å……ä¿¡æ¯
        var mine = ['ğŸ’£', 'ğŸš©', 'â”', 'ğŸ’¥'];
        //è®°å½•é›·çš„æ•°ç»„ï¼Œè®°å½•äº†æ‰€æœ‰æ˜¯é›·çš„åæ ‡
        var mine_arr = [];
        //æ¯ä¸ªæ ¼å­çš„å®½åº¦
        var w = 30;
        //åœ†è§’çŸ©å½¢çš„åœ†è§’åŠå¾„
        var r = 8;
        //æ¯ä¸ªæ ¼å­ä¹‹é—´ç›¸éš”çš„è·ç¦»
        var m = 2;

       

        /**********************************************************
         * å‡½æ•°åï¼šstart
         * å‡½æ•°æ¥å£ï¼šrow è¡Œæ•°ï¼Œcol åˆ—æ•°ï¼Œseed åœ°å›¾ç§å­ï¼Œmod æ¨¡æ•°ï¼Œsize å­å—å¤§å°ï¼Œ mine_num å­å—é›·æ•°
         * å‡½æ•°åŠŸèƒ½ï¼šå¯åŠ¨å¹¶åˆå§‹åŒ–æ¸¸æˆä¿¡æ¯
         * *******************************************************/
        function start(row, col, seed, mod, size, mine_num) {
            init(row, col, seed, mod, size, mine_num);
            get_mine();
            setMine();
        }


        /**********************************************************
         * å‡½æ•°åï¼šset_from
         * å‡½æ•°æ¥å£ï¼šweight æ–¹å—å®½åº¦ï¼Œ radius åœ†è§’çŸ©å½¢çš„åœ†è§’åŠå¾„ï¼Œ dis å—é—´è·
         * å‡½æ•°åŠŸèƒ½ï¼šè®¾ç½®å—å¤§å°ä¸é—´è·
         * *******************************************************/
        function set_from(weight, radius, dis) {
            w = weight;
            r = radius;
            m = dis;
        }


        /**********************************************************
         * å‡½æ•°åï¼šinit
         * å‡½æ•°æ¥å£ï¼šrow è¡Œæ•°ï¼Œcol åˆ—æ•°ï¼Œseed åœ°å›¾ç§å­ï¼Œmod æ¨¡æ•°ï¼Œsize å­å—å¤§å°ï¼Œ mine_num å­å—é›·æ•°
         * å‡½æ•°åŠŸèƒ½ï¼šåˆå§‹åŒ–å˜é‡å¹¶ç”Ÿæˆåœ°å›¾
         * *******************************************************/
        function init(row, col, seed, mod, size, mine_num) {
            //è®¾ç½®åˆå§‹åŒ–å˜é‡
            DEFAULT_ROW_SIZE = row;
            DEFAULT_COL_SZIE = col;
            DEFAULT_SEED = seed;
            DEFAULT_MOD = mod;
            DEFAULT_PART_SIZE = size;
            DEFAULT_PART_MINE_NUM = mine_num;
            DEFAULT_DELTA = seed;
            fib1 = 1;
            fib2 = 2;
            g_arr = [];
            mine_arr = [];

            //å¾ªç¯ç”Ÿæˆåæ ‡ä¿¡æ¯ï¼Œå¹¶åœ¨canvasä¸­ç”»å‡º
            for (let i = 0; i < DEFAULT_ROW_SIZE; i++) {
                for (let j = 0; j < DEFAULT_COL_SZIE; j++) {
                    let xy = j + '-' + i;
                    g_arr.push(xy);
                    g_obj[xy] = { mark: 0, open: 0, init: 0, time: 9999999999 };
                    drawBlock(xy, g_color.block);
                }
            }
        }

        /**********************************************************
         * å‡½æ•°åï¼šget_mine
         * å‡½æ•°æ¥å£ï¼šæ— 
         * å‡½æ•°åŠŸèƒ½ï¼šåˆ©ç”¨è®¾è®¡çš„ç®—æ³•è·å¾—ä¸ºé›·çš„åæ ‡å¹¶å†™å…¥mine_arrä¸­
         * *******************************************************/
        function get_mine() {
            //å¯¹äºæ¯ä¸ªå­å—çš„è¡Œåˆ—å¤§å°
            let currow, curcol;
            //å¾ªç¯çš„åˆ°æ¯ä¸ªå­å—å·¦ä¸Šè§’çš„ç¬¬ä¸€ä¸ªå—
            for (let i = 0; i < DEFAULT_ROW_SIZE; i += DEFAULT_PART_SIZE) {
                for (let j = 0; j < DEFAULT_COL_SZIE; j += DEFAULT_PART_SIZE) {
                    //åˆ¤æ–­æ˜¯å¦è¶Šç•Œï¼Œå¹¶è®¡ç®—å­å—çš„è¾¹é•¿
                    if (i + DEFAULT_PART_SIZE > DEFAULT_ROW_SIZE)
                        currow = DEFAULT_ROW_SIZE - i;
                    else
                        currow = DEFAULT_PART_SIZE;

                    if (j + DEFAULT_PART_SIZE > DEFAULT_COL_SZIE)
                        curcol = DEFAULT_COL_SZIE - j;
                    else
                        curcol = DEFAULT_PART_SIZE;


                    //åˆå§‹åŒ–å­å—ä¿¡æ¯
                    let cnt = 0;
                    let num = currow * curcol * DEFAULT_PART_MINE_NUM;
                    num = ~~(num / (DEFAULT_PART_SIZE * DEFAULT_PART_SIZE));
                    //ç”Ÿæˆå­å—å†…éƒ¨é›·ç¼–å·
                    for (let k = i; k < i + currow; k++) {
                        for (let l = j; l < j + curcol; l++) {
                            let kl = l + '-' + k;
                            g_obj[kl].init = cnt;
                            cnt++;
                        }
                    }

                    //åˆ©ç”¨ç®—æ³•æ‰“ä¹±å†…éƒ¨é¡ºåº
                    for (let k = i; k < i + currow; k++) {
                        for (let l = j; l < j + curcol; l++) {
                            let kl = l + '-' + k;
                            get_change(currow, curcol, i, j, kl);
                        }
                    }


                    //æ ¹æ®æ‰“ä¹±çš„ç¼–å·æ‰¾åˆ°é›·å¹¶æ”¾å…¥mine_arr
                    for (let k = i; k < i + currow; k++) {
                        for (let l = j; l < j + curcol; l++) {
                            let kl = l + '-' + k;
                            if (g_obj[kl].init < num) {
                                mine_arr.push(kl);
                                g_obj[kl].mark = -1;
                            }
                        }
                    }
                }
            }
        }


        /**********************************************************
         * å‡½æ•°åï¼šget_change
         * å‡½æ•°æ¥å£ï¼šrow å­å—è¡Œæ•°ï¼Œ col å­å—åˆ—æ•° , i ç›¸å¯¹åç§»é‡ ï¼Œ j ç›¸å¯¹åç§»é‡
         *          klå¾…äº¤æ¢çš„åæ ‡
         * å‡½æ•°åŠŸèƒ½ï¼šç®—æ³•ä¸­éœ€è¦çš„äº¤æ¢å‡½æ•°ï¼Œç”¨äºå®ç°æ‰“ä¹±é¡ºåº
         * *******************************************************/
        function get_change(row, col, i, j, kl) {
            //è¿­ä»£æ–æ³¢é‚£å¥‘æ•°ç»„
            let temp = fib1;
            fib1 = fib2;
            fib2 = (temp + fib2) % DEFAULT_MOD;
            //è¿­ä»£ç§å­
            while (true) {
                DEFAULT_DELTA = (DEFAULT_DELTA * fib1) % DEFAULT_MOD;
                if (DEFAULT_DELTA > row * col)
                    break;
            }
            //ç”Ÿæˆè¦äº¤æ¢çš„åæ ‡
            let y = DEFAULT_DELTA % row;
            temp = DEFAULT_DELTA;
            temp = ~~(temp / row);
            let x = temp % col;
            let xy = `${x + j}-${y + i}`;
            //è¿›è¡Œäº¤æ¢
            temp = g_obj[xy].init;
            g_obj[xy].init = g_obj[kl].init;
            g_obj[kl].init = temp;
        }

         /**********************************************************
         * å‡½æ•°åï¼šsetMine
         * å‡½æ•°æ¥å£ï¼šæ— 
         * å‡½æ•°åŠŸèƒ½ï¼šæ ¹æ®ç”Ÿæˆçš„mine_arræ•°ç»„ï¼Œç”Ÿæˆæ ¼å­ä¿¡æ¯
         * *******************************************************/
        function setMine() {
            mine_arr.forEach(n => {
                g_obj[n].mark = -1;
                let around = getAround(n);
                around.forEach(xy => {
                    if (g_obj[xy].mark != -1)
                        g_obj[xy].mark++;
                });
            })
        }

        /**********************************************************
         * å‡½æ•°åï¼šshowInfo
         * å‡½æ•°æ¥å£ï¼šæ— 
         * å‡½æ•°åŠŸèƒ½ï¼šè¾…åŠ©æ˜¾ç¤ºå‡½æ•°ï¼Œç”¨äºè°ƒè¯•ï¼Œæ­£å¼æ¸¸ç©æ—¶è¯·ä¸è¦è°ƒç”¨
         * *******************************************************/
        function showInfo() {
            g_arr.forEach(n => {
                if (g_obj[n].mark == -1) {
                    drawBlock(n, g_color.mine);
                    markText(n, mine[0]);
                } else {
                    markText(n, g_obj[n].mark);
                }
            })
        }

        /**********************************************************
         * å‡½æ•°åï¼šmarkText
         * å‡½æ•°æ¥å£ï¼šxy x-yåæ ‡ï¼Œ txt è¦æ˜¾ç¤ºçš„å†…å®¹
         * å‡½æ•°åŠŸèƒ½ï¼šç”¨äºåœ¨æŒ‡å®šçš„(x,y)ä¸Šæ˜¾ç¤ºæ–‡å­—ç­‰å†…å®¹
         * *******************************************************/
        function markText(xy, txt) {
            let [x, y] = xy.split('-').map(n => n * w);
            ctx.save();
            ctx.font = '15px Arial';
            ctx.fillStyle = '#FFF';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(txt, x + w / 2, y + w / 2);
            ctx.restore();
        }

        /**********************************************************
         * å‡½æ•°åï¼šgetaround
         * å‡½æ•°æ¥å£ï¼šxy x-yåæ ‡
         * å‡½æ•°åŠŸèƒ½ï¼šè·å¾—(x,y)åæ ‡å‘¨å›´å…«ä¸ªæ ¼å­å†…æ‰€æœ‰åˆæ³•åæ ‡
         * *******************************************************/
        function getAround(xy) {
            let [x, y] = xy.split('-').map(n => n * 1);
            let around = [];
            for (let i = -1; i <= 1; i++) {
                for (let j = -1; j <= 1; j++) {
                    let id = `${x + j}-${y + i}`;
                    if (g_arr.includes(id) && id != xy)
                        around.push(id);
                }
            }
            return around;
        }

        /**********************************************************
         * å‡½æ•°åï¼šdrawBlock
         * å‡½æ•°æ¥å£ï¼šxy x-yåæ ‡ï¼Œc å¡«å……çš„é¢œè‰²
         * å‡½æ•°åŠŸèƒ½ï¼šç”»åœ†è§’çŸ©å½¢çš„å‡½æ•°ï¼Œå…¶ä¸­(x,y)ä¸ºåæ ‡ï¼Œcä¸ºè¦å¡«å……çš„é¢œè‰²æˆ–æ ·å¼
         * *******************************************************/
        function drawBlock(xy, c) {
            let [x, y] = xy.split('-').map(n => n * w);
            ctx.save();
            ctx.beginPath();
            ctx.moveTo(x, y + r);
            ctx.arcTo(x, y + w - m, x + w - m, y + w - m, r);
            ctx.arcTo(x + w - m, y + w - m, x + w - m, y, r);
            ctx.arcTo(x + w - m, y, x, y, r);
            ctx.arcTo(x, y, x, y + w - m, r);
            ctx.fillStyle = c;
            ctx.fill();
            ctx.restore();
        }

        //ä¸ºç”»å¸ƒå¢åŠ ç›‘å¬äº‹ä»¶
        canv.addEventListener('click', openBlock);
        //ä¸ºç”»å¸ƒå¢åŠ å³é”®ç‚¹å‡»èœå•äº‹ä»¶
        canv.addEventListener("contextmenu", kda);
        

        /**********************************************************
         * å‡½æ•°åï¼šopenBlock
         * å‡½æ•°æ¥å£ï¼ševäº‹ä»¶å˜é‡
         * å‡½æ•°åŠŸèƒ½ï¼šåœ¨ç‚¹å‡»ç”»å¸ƒåè§¦å‘çš„å‡½æ•°ï¼Œé¦–å…ˆä¼šå°†æ ¼å­æ‰“å¼€ï¼Œä¹‹åä¼šå‘é€
         *          æ¶ˆæ¯ç»™æœåŠ¡å™¨
         * *******************************************************/
        function openBlock(ev) {
            //è·å¾— xä¸yåæ ‡
            let x = ~~(ev.offsetX / w);
            let y = ~~(ev.offsetY / w);
            let xy = x + '-' + y;
            //ç‚¹å‡»æ—¶å…³é—­èœå•é¡µé¢
            closeMenu();
            //ç‚¹å‡»ä¸€æ¬¡æ—¶å…ˆå°†æ ¼å­æ‰“å¼€ä¹‹åå†å¤é¢œè‰²
            if (g_arr.includes(xy) && g_obj[xy].open == 0)
                sendmessage(xy);
            if (g_obj[xy].mark == 0 && g_obj[xy].open == 0) {
                g_obj[xy].open = 1;
                markText(xy, g_obj[xy].mark);
                dfszero(xy);
            } else if (g_obj[xy].mark == -1 && g_obj[xy].open == 0) {
                g_obj[xy].open = 1;
                markText(xy, mine[0]);
                markText(xy, mine[3]);
            } else if (g_obj[xy].open == 0) {
                g_obj[xy].open = 1;
                markText(xy, g_obj[xy].mark);
                dfsunzero(xy);
            }
            console.log(x, y);
        }

        /**********************************************************
         * å‡½æ•°åï¼škda
         * å‡½æ•°æ¥å£ï¼ševäº‹ä»¶å˜é‡
         * å‡½æ•°åŠŸèƒ½ï¼šåœ¨å³é”®ç”»å¸ƒåè§¦å‘çš„èœå•å‡½æ•°ï¼Œé˜»æ­¢äº†åŸæœ¬çš„èœå•å‡½æ•°
         *          å¹¶è‡ªå·±æ–°å®šä¹‰äº†ä¸€ä¸ªå¸ƒå±€ï¼Œç”¨äºæ’è¡Œæ¦œ
         * *******************************************************/
        function kda(ev) {
            socket.emit("rank", "query rank")//æ”¶å–æ’è¡Œæ¦œä¿¡æ¯
            ev.preventDefault();
            let e = ev;
            let contextmenu = document.getElementById("context");
            // è·å–èœå•ï¼Œè®©èœå•æ˜¾ç¤ºå‡ºæ¥
            let context = document.getElementById("context");
            context.style.display = "block";
            //  è®©èœå•éšç€é¼ æ ‡çš„ç§»åŠ¨è€Œç§»åŠ¨
            //  è·å–é¼ æ ‡çš„åæ ‡
            let x = e.offsetX;
            let y = e.offsetY;

            //  è°ƒæ•´å®½åº¦å’Œé«˜åº¦
            context.style.left = x - 200 + "px" //Math.min(w-202,x)+"px";
            context.style.top = y + "px" //Math.min(h-230,y)+"px";

            // return falseå¯ä»¥å…³é—­ç³»ç»Ÿé»˜è®¤èœå•
            return false;

        }

        /**********************************************************
         * å‡½æ•°åï¼šdfszero
         * å‡½æ•°æ¥å£ï¼šxy (x,y)çš„åæ ‡
         * å‡½æ•°åŠŸèƒ½ï¼šå¯¹äºç‚¹åˆ°æ ‡è®°ä¸º0æ—¶çš„å—çš„dfsç®—æ³•
         * *******************************************************/
        function dfszero(xy) {
            let around = getAround(xy);
            around.forEach(n => {
                if (g_obj[n].open == 0) {
                    g_obj[n].open = 1;
                    markText(n, g_obj[n].mark);
                    if (g_obj[n].mark == 0)
                        dfszero(n);
                }
            })
        }

        /**********************************************************
         * å‡½æ•°åï¼šdfsunzero
         * å‡½æ•°æ¥å£ï¼šxy (x,y)çš„åæ ‡
         * å‡½æ•°åŠŸèƒ½ï¼šå¯¹äºç‚¹åˆ°æ ‡è®°ä¸ºé0æ—¶çš„å—çš„dfsç®—æ³•
         * *******************************************************/
        function dfsunzero(xy) {
            let around = getAround(xy);
            around.forEach(n => {
                if (g_obj[n].open == 0 && g_obj[n].mark == 0) {
                    g_obj[n].open = 1;
                    markText(n, g_obj[n].mark);
                    dfszero(n);
                }
            })
        }

        /**********************************************************
         * å‡½æ•°åï¼š dfs_color_zero
         * å‡½æ•°æ¥å£ï¼šxy (x,y)çš„åæ ‡ï¼Œ revcoloræ”¶åˆ°çš„é¢œè‰² ï¼Œ timmer æ—¶é—´æˆ³
         * å‡½æ•°åŠŸèƒ½ï¼šå¯¹äºç‚¹åˆ°æ ‡è®°ä¸º0æ—¶çš„å—æ—¶çš„ä¸Šè‰²ç®—æ³•
         * *******************************************************/
        function dfs_color_zero(xy, revcolor, timmer) {
            let around = getAround(xy);
            around.forEach(n => {
                if (g_obj[n].time > timmer) {
                    g_obj[n].time = timmer;
                    drawBlock(n, revcolor);
                    markText(n, g_obj[n].mark);
                    if (g_obj[n].mark == 0)
                        dfs_color_zero(n, revcolor, timmer);
                }
            })
        }

        /**********************************************************
         * å‡½æ•°åï¼š dfs_color_unzero
         * å‡½æ•°æ¥å£ï¼šxy (x,y)çš„åæ ‡ï¼Œ revcoloræ”¶åˆ°çš„é¢œè‰² ï¼Œ timmer æ—¶é—´æˆ³
         * å‡½æ•°åŠŸèƒ½ï¼šå¯¹äºç‚¹åˆ°æ ‡è®°ä¸ºé0æ—¶çš„å—æ—¶çš„ä¸Šè‰²ç®—æ³•
         * *******************************************************/
        function dfs_color_unzero(xy, revcolor, timmer) {
            let around = getAround(xy);
            around.forEach(n => {
                if (g_obj[n].time > timmer && g_obj[n].mark == 0) {
                    g_obj[n].time = timmer;
                    drawBlock(n, revcolor);
                    markText(n, g_obj[n].mark);
                    dfs_color_zero(n, revcolor, timmer);
                }
            })
        }

        /**********************************************************
         * å‡½æ•°åï¼š dfshistoryzero
         * å‡½æ•°æ¥å£ï¼šxy (x,y)çš„åæ ‡ï¼Œ revcoloræ”¶åˆ°çš„é¢œè‰² ï¼Œ timmer æ—¶é—´æˆ³
         * å‡½æ•°åŠŸèƒ½ï¼šå½“å¯¹äºæ–°ç”¨æˆ·è¿›å…¥æ—¶ï¼Œæ”¶åˆ°çš„å†å²æ•°æ®çš„dfsç®—æ³•ï¼Œæ­¤ç®—æ³•åˆ†ä¸º0çš„dfs
         * *******************************************************/
        function dfshistoryzero(xy, revcolor, timmer) {
            let around = getAround(xy);
            around.forEach(n => {
                if (g_obj[n].open == 0) {
                    g_obj[n].open = 1;
                    g_obj[n].time = timmer;
                    drawBlock(n, revcolor);
                    markText(n, g_obj[n].mark);
                    if (g_obj[n].mark == 0)
                        dfshistoryzero(n, revcolor, timmer);
                }
            })
        }

        /**********************************************************
         * å‡½æ•°åï¼š dfshistoryunzero
         * å‡½æ•°æ¥å£ï¼šxy (x,y)çš„åæ ‡ï¼Œ revcoloræ”¶åˆ°çš„é¢œè‰² ï¼Œ timmer æ—¶é—´æˆ³
         * å‡½æ•°åŠŸèƒ½ï¼šå½“å¯¹äºæ–°ç”¨æˆ·è¿›å…¥æ—¶ï¼Œæ”¶åˆ°çš„å†å²æ•°æ®çš„dfsç®—æ³•ï¼Œæ­¤ç®—æ³•åˆ†ä¸ºé0çš„dfs
         * *******************************************************/
        function dfshistoryunzero(xy, revcolor, timmer) {
            let around = getAround(xy);
            around.forEach(n => {
                if (g_obj[n].open == 0 && g_obj[n].mark == 0) {
                    g_obj[n].open = 1;
                    g_obj[n].time = timmer;
                    drawBlock(n, revcolor);
                    markText(n, g_obj[n].mark);
                    dfshistoryzero(n, revcolor, timmer);
                }
            })
        }

        /**********************************************************
         * å‡½æ•°åï¼š dfshistory
         * å‡½æ•°æ¥å£ï¼šxy (x,y)çš„åæ ‡ï¼Œ revcoloræ”¶åˆ°çš„é¢œè‰² ï¼Œ timmer æ—¶é—´æˆ³
         * å‡½æ•°åŠŸèƒ½ï¼šå½“å¯¹äºæ–°ç”¨æˆ·è¿›å…¥æ—¶ï¼Œæ”¶åˆ°çš„å†å²æ•°æ®çš„dfsç®—æ³•ï¼Œæ­¤å‡½æ•°ä¸ºåˆ©ç”¨mark
         *          å€¼è¿›è¡Œåˆ¤æ–­çš„å‡½æ•°ï¼Œå°†å…¶åˆ†ä¸º0ï¼Œé›·ï¼Œå’Œå…¶ä»–
         * *******************************************************/
        function dfshistory(xy, revcolor, timmer) {
            if (g_obj[xy].mark == 0) {
                drawBlock(xy, revcolor);
                markText(xy, g_obj[xy].mark);
                dfshistoryzero(xy, revcolor, timmer);
            } else if (g_obj[xy].mark == -1) {
                drawBlock(xy, revcolor);
                markText(xy, mine[0]);
                markText(xy, mine[3]);
            } else {
                drawBlock(xy, revcolor);
                markText(xy, g_obj[xy].mark);
                dfshistoryunzero(xy, revcolor, timmer);
            }
        }

        /**********************************************************
         * å‡½æ•°åï¼š closeMenu
         * å‡½æ•°æ¥å£ï¼šæ— 
         * å‡½æ•°åŠŸèƒ½ï¼šç”¨äºå…³é—­èœå•é¡µé¢
         * *******************************************************/
        function closeMenu() {
            let contextmenu = document.getElementById("context");
            contextmenu.style.display = "none";
        }
      

    </script>
    
    <script src={{ url_for('static', filename='socket.io.js' ) }}></script>
    <script>
        //æ¥å—ç™»é™†ç•Œé¢cookie
        var this_cookie = decodeURI(document.URL);
        this_cookie = this_cookie.slice(this_cookie.indexOf("=") + 1);
        socket = io.connect('ws://' + document.domain + ':' + location.port + '/wsmine', {
            reconnectionDelayMax: 10000,
            query: {
                "cookie": this_cookie
            }
        });
        
        //è®¾ç½®æ€»æ¦œé¡µé¢åœ°å€å¹¶é€å‡ºç”¨æˆ·åæ•°æ®ä½œä¸ºé‰´åˆ«
        var totalranklink='/seealldata?uname='+this_cookie;
        document.getElementById("totallink").href = totalranklink;



        socket.on("connect", (revconnect) => {
            alert("åœ°å›¾ç”Ÿæˆæ—¶é—´å¯èƒ½è¾ƒé•¿ï¼Œè¯·ç¨ç­‰ï¼\n\næ‰«é›·æ—¶è¯·ä¸è¦å¿«é€Ÿç‚¹å‡»ï¼ŒæœåŠ¡å™¨æ‰¿å—ä¸ä½ï¼");
        })
        
        revseed()
        /**********************************************************
         * å‡½æ•°åï¼š revseed
         * å‡½æ•°æ¥å£ï¼šæ— 
         * å‡½æ•°åŠŸèƒ½ï¼šåˆå§‹åŒ–ï¼Œå»ºç«‹è¿æ¥ï¼Œæ¥æ”¶æœåŠ¡å™¨çš„ç§å­
         * *******************************************************/
        function revseed() {
            socket.on("args", (seedmsg) => {//ç”¨äºæ¥æ”¶æœåŠ¡å™¨å‘é€å®¢æœç«¯
                let seed = JSON.parse(seedmsg);
                let new_row = seed.row;
                let new_col = seed.col;
                let new_partsize = seed.partsize;
                let new_mine = seed.mine;
                let new_mod = seed.mod;
                let new_seed = seed.seed;
                console.log(seed);
                start(new_row, new_col, new_seed, new_mod, new_partsize, new_mine);
                //showInfo();
            })
        }

        //æ¥å—æ¥è‡ªæœåŠ¡å™¨çš„å†å²æ•°æ®ä¿¡æ¯ï¼Œç”¨äºåŒæ­¥æ–°ç”¨æˆ·ä¿¡æ¯
        socket.on("history", (revhistory) => {
            console.log(revhistory);
            let obj = [];
            obj = JSON.parse(revhistory);
            let rows = obj.length
            for (let i = 0; i < rows; i++) {
                console.log(obj[i][0])
                console.log(obj[i][1])
                console.log(obj[i][2])
                let xy = `${obj[i][1]}-${obj[i][0]}`;
                dfshistory(xy, obj[i][2], i + 1);
            }
        })

        //ç”¨äºæ¥æ”¶æœåŠ¡å™¨å‘é€å®¢æœç«¯
        socket.on("rank_rev", (revrank) => {
            let rev_rank = JSON.parse(revrank);
            let tbody = document.querySelector('tbody');
            let child = tbody.childNodes;
            for (let i = child.length - 1; i >= 0; i--) {
                tbody.removeChild(child[i]);
            }
            //åˆ›å»ºå­¦ç”Ÿä¿¡æ¯æ•°ç»„
            let datas = [];
            let sortdata = [];
            let index = [];
            let j = 0;
            //æ ¹æ®keyå€¼æå‡ºjsonå­—å…¸ä¸­çš„å€¼
            for (let key in rev_rank) {
                datas[j] = {
                    name: rev_rank[key].username,
                    boom: rev_rank[key].boom,
                    color: rev_rank[key].color,
                    score: rev_rank[key].score,
                    kd: 0
                };
                j++;
            }
            //è®¡ç®—æ¯ä¸ªç”¨æˆ·çš„kda
            for (let i = 0; i < datas.length; i++) {
                if (datas[i].boom == 0) datas[i].kd = datas[i].score
                else datas[i].kd = datas[i].score / datas[i].boom
                sortdata[i] = datas[i].kd;
                index[i] = [i];
            }
            //æ ¹æ®ç”¨æˆ·çš„kdaè¿›è¡Œæ’åº
            for (let m = 0; m < sortdata.length; m++) {
                for (let n = 0; n < sortdata.length; n++) {
                    if (m != n && sortdata[n] < sortdata[m]) {
                        let tmp = sortdata[n];
                        sortdata[n] = sortdata[m];
                        sortdata[m] = tmp;
                        let tmp_index = index[n];
                        index[n] = index[m];
                        index[m] = tmp_index;
                    }
                }
            }
            //ä½¿ç”¨åŠ¨æ€å»ºè¡¨ç”Ÿæˆæ’è¡Œæ¦œ
            for (let i = 0; i < datas.length; i++) {
                let tr = document.createElement('tr');
                tbody.appendChild(tr); 
                let cur_color = datas[index[i]].color;
                console.log(cur_color);
                for (let k in datas[index[i]]) {
                    if (k == "color")
                        continue;
                    let td = document.createElement('td');
                    if (k == "kd") {
                        td.innerHTML = datas[index[i]][k].toFixed(2);
                        tr.appendChild(td); 
                        tr.style.background = cur_color;
                        continue
                    }
                    td.innerHTML = datas[index[i]][k];
                    tr.appendChild(td); 
                    tr.style.background = cur_color;
                }
            }
        })

        /**********************************************************
         * å‡½æ•°åï¼š sendmessage
         * å‡½æ•°æ¥å£ï¼šxy å³(x,y)åæ ‡
         * å‡½æ•°åŠŸèƒ½ï¼šå½“ç”¨æˆ·ç‚¹å‡»æ—¶ï¼Œå¦‚æœç‚¹å‡»åˆæ³•ï¼Œä¼šç»™æœåŠ¡å™¨å‘é€åæ ‡ä¿¡æ¯
         * *******************************************************/
        function sendmessage(xy) {
            let [x, y] = xy.split('-').map(n => n * 1);
            let sendxy = JSON.stringify({ "x": y, "y": x, "cookie": this_cookie })
            socket.emit('click', sendxy)
        }

        //ç”¨äºæ¥å—æœåŠ¡å™¨ä¸€å±€æ¸¸æˆç»“æŸæ—¶å‘æ¥çš„æ¶ˆæ¯ï¼Œç”¨æ–‡å­—å‘ŠçŸ¥ç”¨æˆ·ç»“æœ
        socket.on("game end", (revend) => {
            let end_msg = JSON.parse(revend);
            let end_str="";
            let datas = [];
            let sortdata = [];
            let index = [];
            let j = 0;
            for (let key in end_msg) {
                datas[j] = {
                    name: end_msg[key].username,
                    boom: end_msg[key].boom,
                    color: end_msg[key].color,
                    score: end_msg[key].score,
                    kd: 0
                };
                j++;
            }
            for (let i = 0; i < datas.length; i++) {
                if (datas[i].boom == 0) datas[i].kd = datas[i].score
                else datas[i].kd = datas[i].score / datas[i].boom
                sortdata[i] = datas[i].kd;
                index[i] = [i];
            }
            for (let m = 0; m < sortdata.length; m++) {
                for (let n = 0; n < sortdata.length; n++) {
                    if (m != n && sortdata[n] < sortdata[m]) {
                        let tmp = sortdata[n];
                        sortdata[n] = sortdata[m];
                        sortdata[m] = tmp;
                        let tmp_index = index[n];
                        index[n] = index[m];
                        index[m] = tmp_index;
                    }
                }
            }
            for (let i = 0; i < datas.length; i++) {
        
                end_str+="ç”¨æˆ·åï¼š"+datas[index[i]].name+" ";
                end_str+="å‘å£å€¼ï¼š"+datas[index[i]].boom+" ";
                end_str+="ä½¿ç”¨é¢œè‰²ï¼š"+datas[index[i]].color+" ";
                end_str+="å¼€è’æ•°ï¼š"+datas[index[i]].score+" ";
                end_str+="K/Dï¼š"+datas[index[i]].kd+" ";
                end_str+="\n"
          
            }
            alert("æœ¬å±€æ¸¸æˆç»“æŸï¼\n"+end_str);
        });
        

        //ç”¨äºæ¥å—æœåŠ¡å™¨çš„å¹¿æ’­æ¶ˆæ¯ï¼Œå³å½“æœ‰ç”¨æˆ·ç‚¹å‡»æ—¶ï¼Œæ›´æ–°æ‰€æœ‰ç”¨æˆ·çš„ç•Œé¢
        socket.on("broadcast", (revbroad) => {
            let msg = JSON.parse(revbroad);
            let revx = msg.y;
            let revy = msg.x;
            let revcolor = msg.color;
            let revtimmer = msg.timmer;
            let xy = `${revx}-${revy}`;
            console.log(msg);
            //é¦–å…ˆå°†æ ¼å­æ‰“å¼€
            if (g_obj[xy].mark == 0 && g_obj[xy].open == 0) {
                g_obj[xy].open = 1;
                markText(xy, g_obj[xy].mark);
                dfszero(xy);
            } else if (g_obj[xy].mark == -1 && g_obj[xy].open == 0) {
                g_obj[xy].open = 1;
                markText(xy, mine[0]);
                markText(xy, mine[3]);
            } else if (g_obj[xy].open == 0) {
                g_obj[xy].open = 1;
                markText(xy, g_obj[xy].mark);
                dfsunzero(xy);
            }
            //ä¹‹åå°†æ ¼å­ä¸Šè‰²
            if (g_obj[xy].mark == 0 && g_obj[xy].time > revtimmer) {
                g_obj[xy].time = revtimmer;
                drawBlock(xy, revcolor);
                markText(xy, g_obj[xy].mark);
                dfs_color_zero(xy, revcolor, revtimmer);
            } else if (g_obj[xy].mark == -1 && g_obj[xy].time > revtimmer) {
                g_obj[xy].time = revtimmer;
                drawBlock(xy, revcolor);
                markText(xy, mine[0]);
                markText(xy, mine[3]);
            } else if (g_obj[xy].time > revtimmer) {
                g_obj[xy].time = revtimmer;
                drawBlock(xy, revcolor);
                markText(xy, g_obj[xy].mark);
                dfs_color_unzero(xy, revcolor, revtimmer);
            }
        })

    </script>



</body>

</html>